// ============================================================================
// PERFORMANCE OPTIMIZATION - HOUSE LOVE PREMIUM UX
// ============================================================================
// This file contains performance optimization components including lazy loading,
// skeleton screens, image optimization, and progressive enhancement.

@import './design-system.scss';
@import './interactions.scss';

// ============================================================================
// LAZY LOADING SYSTEM
// ============================================================================

// Lazy Loading Container
.lazy-container {
  position: relative;
  overflow: hidden;
  
  &.loading {
    background: $neutral-100;
    border-radius: $radius-md;
    
    &::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, $neutral-100 25%, $neutral-50 50%, $neutral-100 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
  }
  
  &.loaded {
    background: none;
    
    &::before {
      display: none;
    }
  }
}

// Lazy Image Component
.lazy-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  opacity: 0;
  transition: opacity 0.3s ease;
  
  &.loaded {
    opacity: 1;
  }
  
  &.error {
    opacity: 0.5;
    filter: grayscale(0.3);
  }
}

// Lazy Content Placeholder
.lazy-placeholder {
  background: $neutral-100;
  border-radius: $radius-md;
  display: flex;
  align-items: center;
  justify-content: center;
  color: $text-muted;
  @include body-small;
  min-height: 200px;
  
  &.loading {
    @extend .skeleton;
  }
  
  .placeholder-icon {
    font-size: $icon-size-xl;
    margin-bottom: $spacing-2;
    opacity: 0.5;
  }
  
  .placeholder-text {
    text-align: center;
  }
}

// Intersection Observer Wrapper
.intersection-observer {
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.6s ease;
  
  &.visible {
    opacity: 1;
    transform: translateY(0);
  }
  
  &.stagger-1 { transition-delay: 0.1s; }
  &.stagger-2 { transition-delay: 0.2s; }
  &.stagger-3 { transition-delay: 0.3s; }
  &.stagger-4 { transition-delay: 0.4s; }
  &.stagger-5 { transition-delay: 0.5s; }
}

// ============================================================================
// SKELETON SCREENS & LOADING STATES
// ============================================================================

// Enhanced Skeleton System
.skeleton {
  background: linear-gradient(90deg, $neutral-200 25%, $neutral-100 50%, $neutral-200 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
  border-radius: $radius-sm;
  
  // Skeleton Text Variants
  &.skeleton-text {
    height: 1em;
    margin-bottom: $spacing-2;
    
    &.skeleton-title {
      height: 1.5em;
      width: 80%;
    }
    
    &.skeleton-subtitle {
      height: 1.2em;
      width: 60%;
    }
    
    &.skeleton-body {
      height: 1em;
      width: 100%;
      
      &:last-child {
        width: 70%;
      }
    }
  }
  
  // Skeleton Avatar Variants
  &.skeleton-avatar {
    border-radius: 50%;
    
    &.skeleton-avatar-sm {
      width: 2rem;
      height: 2rem;
    }
    
    &.skeleton-avatar-md {
      width: 3rem;
      height: 3rem;
    }
    
    &.skeleton-avatar-lg {
      width: 4rem;
      height: 4rem;
    }
    
    &.skeleton-avatar-xl {
      width: 6rem;
      height: 6rem;
    }
  }
  
  // Skeleton Button Variants
  &.skeleton-button {
    border-radius: $radius-md;
    
    &.skeleton-button-sm {
      height: $button-height-sm;
      width: 80px;
    }
    
    &.skeleton-button-md {
      height: $button-height-md;
      width: 120px;
    }
    
    &.skeleton-button-lg {
      height: $button-height-lg;
      width: 160px;
    }
  }
  
  // Skeleton Card Variants
  &.skeleton-card {
    border-radius: $radius-lg;
    
    &.skeleton-card-sm {
      height: 150px;
    }
    
    &.skeleton-card-md {
      height: 200px;
    }
    
    &.skeleton-card-lg {
      height: 300px;
    }
  }
  
  // Skeleton Form Variants
  &.skeleton-input {
    height: $input-height-md;
    border-radius: $radius-md;
  }
  
  &.skeleton-textarea {
    height: 100px;
    border-radius: $radius-md;
  }
  
  &.skeleton-select {
    height: $input-height-md;
    border-radius: $radius-md;
  }
  
  // Skeleton List Variants
  &.skeleton-list-item {
    height: 60px;
    border-radius: $radius-md;
    margin-bottom: $spacing-3;
  }
  
  // Skeleton Table Variants
  &.skeleton-table-header {
    height: 40px;
    border-radius: $radius-sm;
    margin-bottom: $spacing-2;
  }
  
  &.skeleton-table-row {
    height: 50px;
    border-radius: $radius-sm;
    margin-bottom: $spacing-2;
  }
}

// Skeleton Content Groups
.skeleton-content {
  .skeleton-header {
    margin-bottom: $spacing-4;
    
    .skeleton-title {
      @extend .skeleton;
      @extend .skeleton-text;
      @extend .skeleton-title;
      margin-bottom: $spacing-2;
    }
    
    .skeleton-subtitle {
      @extend .skeleton;
      @extend .skeleton-text;
      @extend .skeleton-subtitle;
    }
  }
  
  .skeleton-body {
    .skeleton-text {
      @extend .skeleton;
      @extend .skeleton-text;
      @extend .skeleton-body;
    }
  }
  
  .skeleton-actions {
    margin-top: $spacing-4;
    display: flex;
    gap: $spacing-3;
    
    .skeleton-button {
      @extend .skeleton;
      @extend .skeleton-button;
      @extend .skeleton-button-md;
    }
  }
}

// Skeleton Card Layout
.skeleton-card-layout {
  .skeleton-card {
    @extend .skeleton;
    @extend .skeleton-card;
    @extend .skeleton-card-md;
    margin-bottom: $spacing-4;
    
    .skeleton-card-content {
      padding: $spacing-4;
      
      .skeleton-card-header {
        display: flex;
        align-items: center;
        gap: $spacing-3;
        margin-bottom: $spacing-3;
        
        .skeleton-avatar {
          @extend .skeleton;
          @extend .skeleton-avatar;
          @extend .skeleton-avatar-md;
        }
        
        .skeleton-card-title {
          @extend .skeleton;
          @extend .skeleton-text;
          @extend .skeleton-title;
          flex: 1;
        }
      }
      
      .skeleton-card-body {
        .skeleton-text {
          @extend .skeleton;
          @extend .skeleton-text;
          @extend .skeleton-body;
        }
      }
    }
  }
}

// ============================================================================
// IMAGE OPTIMIZATION
// ============================================================================

// Responsive Image Container
.responsive-image {
  position: relative;
  width: 100%;
  height: 100%;
  overflow: hidden;
  border-radius: $radius-md;
  
  .image-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    
    img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }
    
    &:hover img {
      transform: scale(1.05);
    }
  }
  
  // Image Loading States
  &.loading {
    background: $neutral-100;
    
    &::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, $neutral-100 25%, $neutral-50 50%, $neutral-100 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
  }
  
  &.loaded {
    background: none;
    
    &::before {
      display: none;
    }
  }
  
  &.error {
    background: $neutral-100;
    display: flex;
    align-items: center;
    justify-content: center;
    color: $text-muted;
    
    .error-icon {
      font-size: $icon-size-xl;
      opacity: 0.5;
    }
  }
}

// Picture Element for Multiple Sources
.picture-element {
  width: 100%;
  height: 100%;
  
  picture {
    width: 100%;
    height: 100%;
    display: block;
    
    img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
  }
}

// WebP Fallback Support
.webp-fallback {
  .webp-image {
    display: block;
    
    .no-webp & {
      display: none;
    }
  }
  
  .fallback-image {
    display: none;
    
    .no-webp & {
      display: block;
    }
  }
}

// ============================================================================
// INFINITE SCROLL & PAGINATION
// ============================================================================

// Infinite Scroll Container
.infinite-scroll {
  .scroll-content {
    min-height: 400px;
  }
  
  .scroll-trigger {
    height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: $spacing-4 0;
    
    .loading-spinner {
      @extend .loading-spinner;
      @extend .loading-spinner-lg;
    }
  }
  
  .scroll-end {
    text-align: center;
    padding: $spacing-6;
    color: $text-muted;
    @include body-medium;
    
    .end-icon {
      font-size: $icon-size-xl;
      margin-bottom: $spacing-2;
      opacity: 0.5;
    }
  }
}

// Enhanced Pagination
.pagination {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: $spacing-2;
  margin: $spacing-6 0;
  
  .pagination-item {
    @extend .btn;
    @extend .btn-outline;
    @extend .btn-sm;
    min-width: 40px;
    height: 40px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    
    &.active {
      background: $primary-500;
      color: $text-primary;
      border-color: $primary-500;
    }
    
    &:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  }
  
  .pagination-ellipsis {
    padding: $spacing-2;
    color: $text-muted;
    @include body-small;
  }
  
  .pagination-info {
    @include body-small;
    color: $text-muted;
    margin-left: $spacing-4;
  }
}

// ============================================================================
// CRITICAL RENDERING PATH OPTIMIZATION
// ============================================================================

// Critical Content Wrapper
.critical-content {
  // Ensure critical content renders first
  contain: layout style paint;
  
  .critical-text {
    // Optimize text rendering
    text-rendering: optimizeLegibility;
    font-feature-settings: "kern" 1;
  }
  
  .critical-image {
    // Prioritize critical images
    fetchpriority: high;
  }
}

// Non-Critical Content
.non-critical-content {
  // Defer non-critical content
  contain: layout style;
  
  &.lazy-load {
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.6s ease;
    
    &.loaded {
      opacity: 1;
      transform: translateY(0);
    }
  }
}

// Content Priority System
.content-priority {
  &.priority-high {
    // Render immediately
    contain: layout style paint;
  }
  
  &.priority-medium {
    // Render after high priority
    contain: layout style;
  }
  
  &.priority-low {
    // Render last
    contain: layout;
  }
}

// ============================================================================
// PRELOADING & PREDICTIVE LOADING
// ============================================================================

// Preload Indicators
.preload-indicator {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 3px;
  background: $neutral-200;
  z-index: $z-modal;
  
  .preload-bar {
    height: 100%;
    background: linear-gradient(90deg, $primary-500, $primary-600);
    width: 0%;
    transition: width 0.3s ease;
    position: relative;
    
    &::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: progressShine 2s infinite;
    }
  }
}

// Predictive Loading
.predictive-loading {
  .predictive-trigger {
    position: relative;
    
    &::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba($primary-500, 0.1);
      opacity: 0;
      transition: opacity 0.3s ease;
      border-radius: $radius-md;
    }
    
    &:hover::before {
      opacity: 1;
    }
  }
  
  .predictive-content {
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.3s ease;
    
    &.predictive-loaded {
      opacity: 1;
      transform: translateY(0);
    }
  }
}

// ============================================================================
// PROGRESSIVE ENHANCEMENT
// ============================================================================

// Progressive Enhancement Wrapper
.progressive-enhancement {
  // Base functionality for all browsers
  .base-functionality {
    display: block;
  }
  
  // Enhanced functionality for modern browsers
  .enhanced-functionality {
    display: none;
    
    .enhanced & {
      display: block;
    }
  }
  
  // Fallback for older browsers
  .fallback-functionality {
    display: block;
    
    .enhanced & {
      display: none;
    }
  }
}

// Feature Detection
.feature-detection {
  .feature-supported {
    display: none;
    
    .supports-grid & {
      display: block;
    }
    
    .supports-flexbox & {
      display: block;
    }
    
    .supports-css-variables & {
      display: block;
    }
  }
  
  .feature-unsupported {
    display: block;
    
    .supports-grid &,
    .supports-flexbox &,
    .supports-css-variables & {
      display: none;
    }
  }
}

// Performance Monitoring
.performance-monitor {
  position: fixed;
  bottom: $spacing-4;
  left: $spacing-4;
  background: $bg-surface;
  border: 1px solid $neutral-200;
  border-radius: $radius-lg;
  padding: $spacing-3;
  box-shadow: $shadow-lg;
  z-index: $z-fixed;
  font-family: monospace;
  @include body-small;
  color: $text-muted;
  
  .performance-metric {
    margin-bottom: $spacing-1;
    
    &:last-child {
      margin-bottom: 0;
    }
    
    .metric-label {
      color: $text-secondary;
    }
    
    .metric-value {
      color: $text-primary;
      font-weight: $font-weight-semibold;
    }
  }
}

// ============================================================================
// RESPONSIVE PERFORMANCE
// ============================================================================

// Mobile Performance Optimizations
@media (max-width: $breakpoint-md) {
  .skeleton {
    // Reduce animation complexity on mobile
    animation-duration: 2s;
  }
  
  .intersection-observer {
    // Reduce animation distance on mobile
    transform: translateY(10px);
  }
  
  .lazy-container {
    // Optimize for mobile memory constraints
    &.loading {
      background: $neutral-100;
      
      &::before {
        display: none; // Disable shimmer on mobile
      }
    }
  }
}

// High DPI Display Optimizations
@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
  .skeleton {
    // Optimize for high DPI displays
    background-size: 100% 100%;
  }
}

// Reduced Motion Support
@media (prefers-reduced-motion: reduce) {
  .skeleton {
    animation: none;
    background: $neutral-200;
  }
  
  .intersection-observer {
    transition: none;
    opacity: 1;
    transform: none;
  }
  
  .lazy-container {
    transition: none;
  }
  
  .responsive-image img {
    transition: none;
    
    &:hover {
      transform: none;
    }
  }
}

// Low Power Mode Support
@media (prefers-reduced-data: reduce) {
  .lazy-container {
    // Disable lazy loading in low power mode
    &.loading {
      background: $neutral-100;
      
      &::before {
        display: none;
      }
    }
  }
  
  .skeleton {
    // Simplify skeleton animations
    animation: none;
    background: $neutral-200;
  }
}